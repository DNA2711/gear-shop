# H∆∞·ªõng d·∫´n c·∫•u h√¨nh VNPay

## T·ªïng quan

H·ªá th·ªëng thanh to√°n s·ª≠ d·ª•ng VNPay API v·ªõi strategy kh√°c nhau cho development v√† production:

- **Development**: Redirect v·ªÅ success page v·ªõi polling ƒë·ªÉ check payment status
- **Production**: S·ª≠ d·ª•ng VNPay callback API ƒë·ªÉ nh·∫≠n k·∫øt qu·∫£ thanh to√°n

Ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang thanh to√°n c·ªßa VNPay ƒë·ªÉ ho√†n t·∫•t giao d·ªãch.

## C·∫•u h√¨nh Environment Variables

Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng sau v√†o file `.env` c·ªßa b·∫°n:

```env
# VNPay Configuration
VNPAY_TMN_CODE="your-vnpay-terminal-code"
VNPAY_SECURE_SECRET="your-vnpay-secure-secret"
VNPAY_HOST="https://sandbox.vnpayment.vn"  # Sandbox
# VNPAY_HOST="https://vnpayment.vn"          # Production

# Base URL for callbacks
NEXT_PUBLIC_BASE_URL="http://localhost:3000"  # Development
# NEXT_PUBLIC_BASE_URL="https://yourdomain.com"  # Production
```

### Sandbox (M√¥i tr∆∞·ªùng test)

ƒê·ªÉ test v·ªõi VNPay Sandbox, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng th√¥ng tin demo:

- **TMN Code**: `DEMO` ho·∫∑c ƒëƒÉng k√Ω t·∫°i [sandbox.vnpayment.vn](https://sandbox.vnpayment.vn)
- **Secure Secret**: `DEMO_SECRET` ho·∫∑c l·∫•y t·ª´ sandbox portal
- **Host**: `https://sandbox.vnpayment.vn`

### Production (M√¥i tr∆∞·ªùng th·∫≠t)

ƒê·ªÉ chuy·ªÉn sang production:

1. ƒêƒÉng k√Ω merchant t·∫°i [vnpayment.vn](https://vnpayment.vn)
2. L·∫•y TMN Code v√† Secure Secret t·ª´ VNPay
3. C·∫≠p nh·∫≠t `VNPAY_HOST` th√†nh `https://vnpayment.vn`
4. ƒê·∫∑t `testMode: false` trong VNPay config

## Flow thanh to√°n

### 1. T·∫°o ƒë∆°n h√†ng

- User ƒëi·ªÅn th√¥ng tin v√† nh·∫•n "ƒê·∫∑t h√†ng"
- Server t·∫°o order v·ªõi status `pending`
- Hi·ªÉn th·ªã modal VNPay Payment

### 2. Chuy·ªÉn h∆∞·ªõng VNPay

- User nh·∫•n "Thanh to√°n ngay"
- Server g·ªçi API t·∫°o VNPay payment URL v·ªõi return URL ph√π h·ª£p:
  - **Development**: `localhost:3000/checkout/success?orderId=123&from=vnpay`
  - **Production**: `yourdomain.com/api/vnpay/callback`
- User ƒë∆∞·ª£c redirect ƒë·∫øn VNPay gateway

### 3. Thanh to√°n t·∫°i VNPay

- User ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n (ATM, Visa/Master, QR...)
- Ho√†n t·∫•t thanh to√°n t·∫°i VNPay

### 4. X·ª≠ l√Ω k·∫øt qu·∫£

#### Development Mode:

- **Mock VNPay Gateway**: Redirect ƒë·∫øn `/vnpay/checkout` - trang gi·∫£ l·∫≠p VNPay
- Trang mock c√≥ ƒë·∫ßy ƒë·ªß UI gi·ªëng VNPay th·∫≠t v·ªõi c√°c ph∆∞∆°ng th·ª©c thanh to√°n
- User c√≥ th·ªÉ ch·ªçn "Thanh to√°n th√†nh c√¥ng" ho·∫∑c "Thanh to√°n th·∫•t b·∫°i" ƒë·ªÉ test
- T·ª± ƒë·ªông c·∫≠p nh·∫≠t order status v√† redirect v·ªÅ success page
- **Kh√¥ng c·∫ßn polling** - k·∫øt qu·∫£ tr·∫£ v·ªÅ ngay l·∫≠p t·ª©c
- **Ho√†n to√†n kh√¥ng c·∫ßn internet/VNPay API** trong development

#### Production Mode:

- VNPay callback v·ªÅ `/api/vnpay/callback`
- Server verify signature v√† c·∫≠p nh·∫≠t order status
- User ƒë∆∞·ª£c redirect v·ªÅ success page ho·∫∑c error page

## API Endpoints m·ªõi

### POST `/api/vnpay/create-payment-url`

T·∫°o payment URL ƒë·ªÉ redirect ƒë·∫øn VNPay.

**Request:**

```json
{
  "orderId": "12345",
  "amount": 100000,
  "orderInfo": "Thanh to√°n ƒë∆°n h√†ng #12345"
}
```

**Response:**

```json
{
  "success": true,
  "paymentUrl": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?...",
  "orderId": "12345"
}
```

### GET `/api/vnpay/callback`

X·ª≠ l√Ω callback t·ª´ VNPay sau khi thanh to√°n (ch·ªâ d√πng trong production).

**Query Parameters:** C√°c tham s·ªë do VNPay g·ª≠i v·ªÅ

**Actions:**

- Verify signature
- Update order status
- Redirect user ƒë·∫øn success/error page

### POST `/api/vnpay/simulate-payment` (Development Only)

Simulate payment callback trong development mode.

**Request:**

```json
{
  "orderId": "12345",
  "status": "paid" // ho·∫∑c "failed"
}
```

**Response:**

```json
{
  "success": true,
  "orderId": "12345",
  "status": "paid",
  "message": "Order 12345 status updated to paid"
}
```

**L∆∞u √Ω:** API n√†y ch·ªâ ho·∫°t ƒë·ªông khi `NODE_ENV !== "production"`

## Components m·ªõi

### `VNPayPayment`

Thay th·∫ø component `VNPayQRCode` c≈©:

```tsx
<VNPayPayment
  orderId={orderId}
  amount={totalAmount}
  orderInfo={`Thanh to√°n ƒë∆°n h√†ng #${orderId}`}
  onPaymentSuccess={handlePaymentSuccess}
/>
```

**Props:**

- `orderId`: ID ƒë∆°n h√†ng
- `amount`: S·ªë ti·ªÅn (VNƒê)
- `orderInfo`: M√¥ t·∫£ giao d·ªãch
- `onPaymentSuccess`: Callback khi thanh to√°n th√†nh c√¥ng

## Testing

### Th√¥ng tin test VNPay Sandbox

**Th·∫ª ATM n·ªôi ƒë·ªãa:**

- S·ªë th·∫ª: `9704198526191432198`
- T√™n ch·ªß th·∫ª: `NGUYEN VAN A`
- Ng√†y ph√°t h√†nh: `07/15`
- M·∫≠t kh·∫©u: `123456`

**Th·∫ª qu·ªëc t·∫ø:**

- S·ªë th·∫ª: `4000000000000002`
- CVV: `123`
- Ng√†y h·∫øt h·∫°n: `12/25`

### Test scenarios

1. **Thanh to√°n th√†nh c√¥ng**: S·ª≠ d·ª•ng th√¥ng tin test card h·ª£p l·ªá
2. **Thanh to√°n th·∫•t b·∫°i**: Nh·∫≠p sai th√¥ng tin ho·∫∑c h·ªßy thanh to√°n
3. **Callback error**: Test x·ª≠ l√Ω l·ªói callback
4. **Order not found**: Test v·ªõi orderId kh√¥ng t·ªìn t·∫°i

## Troubleshooting

### L·ªói th∆∞·ªùng g·∫∑p

1. **"Kh√¥ng t√¨m th·∫•y website"** (FIXED): ƒê√£ ƒë∆∞·ª£c fix b·∫±ng mock VNPay cho development
2. **Invalid signature**: Ki·ªÉm tra VNPAY_SECURE_SECRET (ch·ªâ production)
3. **Order not found**: ƒê·∫£m b·∫£o orderId t·ªìn t·∫°i trong database
4. **Callback error**: Ki·ªÉm tra NEXT_PUBLIC_BASE_URL ƒë√∫ng (ch·ªâ production)
5. **Payment URL not created**: Ki·ªÉm tra VNPAY_TMN_CODE v√† c·∫•u h√¨nh (ch·ªâ production)
6. **S·ªë ti·ªÅn giao d·ªãch kh√¥ng h·ª£p l·ªá**: VNPay y√™u c·∫ßu s·ªë ti·ªÅn t·ª´ 5,000 VND ƒë·∫øn d∆∞·ªõi 1 t·ª∑ VND

### Development vs Production

**Development (localhost):**

- ‚úÖ Ho·∫°t ƒë·ªông 100% offline
- ‚úÖ Kh√¥ng c·∫ßn VNPay credentials
- ‚úÖ Kh√¥ng c·∫ßn internet
- ‚úÖ UI gi·ªëng VNPay th·∫≠t
- ‚úÖ Test ƒë∆∞·ª£c c·∫£ success/failed cases

**Production (deployed):**

- ‚úÖ S·ª≠ d·ª•ng VNPay API th·∫≠t
- ‚úÖ C·∫ßn VNPay credentials
- ‚úÖ C·∫ßn HTTPS domain
- ‚úÖ Callback th·ª±c t·∫ø t·ª´ VNPay

### Logs

Ki·ªÉm tra logs trong browser console v√† server logs ƒë·ªÉ debug:

```bash
# Server logs
npm run dev

# Browser console
F12 -> Console tab
```

## Migration t·ª´ QR Code

### Files ƒë√£ thay ƒë·ªïi

1. **ƒê√£ x√≥a**: 
   - `src/components/checkout/VNPayQRCode.tsx`
   - `src/app/api/get-ngrok-url/route.ts` (ngrok API)
2. **ƒê√£ th√™m**:
   - `src/components/checkout/VNPayPayment.tsx`
   - `src/app/api/vnpay/create-payment-url/route.ts`
   - `src/app/api/vnpay/callback/route.ts`
   - `src/app/api/vnpay/simulate-payment/route.ts` (development only)
   - `src/app/vnpay/checkout/page.tsx` (mock VNPay gateway)
3. **ƒê√£ c·∫≠p nh·∫≠t**:
   - `src/app/checkout/page.tsx`
   - `src/app/checkout/success/page.tsx`

### Flow Testing

**C√°ch test trong development:**

1. T·∫°o ƒë∆°n h√†ng t·∫°i `/checkout`
2. Nh·∫•n "Thanh to√°n VNPay" 
3. ƒê∆∞·ª£c redirect ƒë·∫øn `/vnpay/checkout` (mock VNPay)
4. Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n (ATM/Visa/QR)
5. Nh·∫•n "Thanh to√°n th√†nh c√¥ng" ho·∫∑c "Thanh to√°n th·∫•t b·∫°i"
6. ƒê∆∞·ª£c redirect v·ªÅ `/checkout/success` v·ªõi k·∫øt qu·∫£

**UI Features:**
- üé® Thi·∫øt k·∫ø gi·ªëng VNPay th·∫≠t
- üèß C√°c ph∆∞∆°ng th·ª©c thanh to√°n (ATM, Visa, QR)
- ‚ö†Ô∏è Warning r√µ r√†ng v·ªÅ development mode
- ‚úÖ Test c·∫£ success v√† failed cases
- üîÑ Spinner animation khi processing

**L·ª£i √≠ch:**
- ‚úÖ Kh√¥ng c·∫ßn ngrok, tunneling tools
- ‚úÖ Ho·∫°t ƒë·ªông offline 100%
- ‚úÖ Test UI/UX nh∆∞ th·∫≠t
- ‚úÖ Debug d·ªÖ d√†ng
- ‚úÖ Fast development cycle

### Breaking changes

- Component `VNPayQRCode` kh√¥ng c√≤n t·ªìn t·∫°i
- **Ho√†n to√†n lo·∫°i b·ªè ngrok** - kh√¥ng c√≤n c·∫ßn thi·∫øt
- API `/api/get-ngrok-url` ƒë√£ b·ªã x√≥a
- Environment variables m·ªõi cho VNPay
- Flow kh√°c nhau cho development vs production

## Validation & B·∫£o m·∫≠t

### Validation s·ªë ti·ªÅn

- **T·ªëi thi·ªÉu**: 5,000 VND
- **T·ªëi ƒëa**: d∆∞·ªõi 1 t·ª∑ VND (999,999,999 VND)
- Validation ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü c·∫£ frontend v√† backend
- N√∫t thanh to√°n s·∫Ω b·ªã disable n·∫øu s·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá
- Hi·ªÉn th·ªã c·∫£nh b√°o r√µ r√†ng cho ng∆∞·ªùi d√πng

### B·∫£o m·∫≠t

- Lu√¥n verify signature t·ª´ VNPay callback
- S·ª≠ d·ª•ng HTTPS cho production
- B·∫£o m·∫≠t VNPAY_SECURE_SECRET
- Validate t·∫•t c·∫£ parameters t·ª´ callback
- Ki·ªÉm tra format v√† range c·ªßa amount tr∆∞·ªõc khi g·ª≠i request
